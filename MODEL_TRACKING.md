# Model Tracking Feature

## Overview

Each message now tracks which AI model was used to generate it. This allows you to:
- Know exactly which model generated each response
- Compare responses from different models
- Debug issues with specific models
- Track model usage over time

## Database Schema

### Messages Table

The `messages` table now includes a `model` field:

```sql
CREATE TABLE messages (
    id UUID PRIMARY KEY,
    chat_id UUID NOT NULL,
    user_id UUID NOT NULL,
    role TEXT NOT NULL,
    content TEXT NOT NULL,
    model TEXT,              -- NEW: Tracks which model was used
    created_at TIMESTAMPTZ NOT NULL,
    is_pending BOOLEAN DEFAULT FALSE,
    has_error BOOLEAN DEFAULT FALSE
);
```

## Migration for Existing Databases

If you already have an existing database, run the migration script:

```bash
# Apply the migration in your Supabase SQL Editor
supabase_migration_add_model_to_messages.sql
```

Or manually run:

```sql
ALTER TABLE messages ADD COLUMN IF NOT EXISTS model TEXT;
CREATE INDEX IF NOT EXISTS idx_messages_model ON messages(model);
```

## How It Works

### 1. Model Configuration

The model is configured via environment variable in `.env`:

```bash
OPENROUTER_MODEL=anthropic/claude-3-sonnet
```

### 2. Message Creation

When an assistant message is created:

```dart
ChatMessage(
  role: ChatRole.assistant,
  content: response,
  model: 'anthropic/claude-3-sonnet',  // Automatically saved
)
```

### 3. Model Storage

- **User messages**: No model field (they don't need one)
- **System messages**: No model field (prompts)
- **Assistant messages**: Include the model that generated the response

### 4. Accessing Model Information

You can access the model for any message:

```dart
final message = chatProvider.messages[index];
if (message.model != null) {
  print('Generated by: ${message.model}');
}
```

## Use Cases

### 1. Display Model in UI

Show which model generated each response:

```dart
if (message.role == ChatRole.assistant && message.model != null) {
  Text('${message.model}', 
    style: TextStyle(fontSize: 10, color: Colors.grey));
}
```

### 2. Filter Messages by Model

Query messages from a specific model:

```sql
SELECT * FROM messages 
WHERE model = 'anthropic/claude-3-sonnet' 
  AND user_id = 'xxx';
```

### 3. Analytics

Track which models are used most:

```sql
SELECT model, COUNT(*) as count 
FROM messages 
WHERE role = 'assistant' 
  AND user_id = 'xxx'
GROUP BY model 
ORDER BY count DESC;
```

## Data Model

### ChatMessage Class

```dart
class ChatMessage {
  final ChatRole role;
  final String content;
  final String? model;  // NEW: Optional model field
  final DateTime createdAt;
  final bool isPending;
  final bool hasError;
  final String id;
}
```

## Benefits

1. **Transparency**: Users know exactly which AI model they're interacting with
2. **Debugging**: Easier to identify model-specific issues
3. **Comparison**: Compare responses from different models
4. **Compliance**: Track model usage for audit purposes
5. **Flexibility**: Prepare for multi-model support in the future

## Future Enhancements

Possible future features:
- Allow users to switch models mid-conversation
- Display model badges in the UI
- Model usage statistics
- Per-message model selection
- Cost tracking per model

